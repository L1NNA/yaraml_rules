# Sophos AI YaraML Rules Repository
*Questions, concerns, ideas, results, feedback appreciated, please email joshua.saxe@sophos.com*
YaraML is a tool that generates Yara rules that are really sklearn ML models.  Give it a directory of malware files and a directory of benign files and it'll extract features, train a model, and then "compile" the model into a Yara rule.  To get a feel for what this looks like, see the logistic regression Powershell detector generated by YaraML and given below.

```
rule Generic_Powershell_Detector
{
strings:
...
$s4 = "DownloadFile"       fullword // weight: 3.257
$s5 = "WOW64"              fullword // weight: 3.232
$s6 = "bypass"             fullword // weight: 3.021
$s7 = "meMoRYSTrEaM"       fullword // weight: 2.68
$s8 = "obJEct"             fullword // weight: 2.679
$s9 = "OBJecT"             fullword // weight: 2.659
$s10 = "ReGeX"              fullword // weight: 2.592
$s11 = "samratashok"        fullword // weight: 2.548
$s12 = "Dependencies"       fullword // weight: 2.494
$s13 = "TVqQAAMAAAAEAAAA"   fullword // weight: 2.428
$s14 = "CompressionMode"    fullword // weight: 2.366
...
condition:
...
((#s0 * 5.567) + (#s1 * 4.122) + (#s2 * 3.904) + (#s3 * 3.820) + 
(#s4 * 3.257) + (#s5 * 3.232) + (#s6 * 3.021) + (#s7 * 2.680) + 
(#s8 * 2.679) + (#s9 * 2.659) + (#s10 * 2.592) + (#s11 * 2.548) + 
...
> 0
}
```
Here's the ROC curve this rule achieves.  You can move around in ROC space by changing the threshold after the '>' sign at the end of the file.  N.B. *For this particular rule, you'll need to make sure you're scanning powershell script files* -- it'll FP on binary files, because it wasn't trained on these.


![Powershell ROC curve](https://github.com/inv-ds-research/yaraml_rules/blob/master/generic_powershell_detector_jan28_2020/validation_roc_with_recommended_thresholds.png?raw=true)


## Why?

Because ML rules are a good complement to hand-written rules.  Machine learning has some nice properties: let's you dial a detection threshold to trade off between false positives and false negatives, and often produces superior detection rates when it has a lot of training data.  When we only have a few examples of a malicious family, expert humans can probably write better rules.

## What's the structure of this repository?

At the top level we'll release rules that we think are good enough that they can be of benefit to the community at least as examples of the kinds of ML models YaraML can generate.  In the yaraml_generator/ directory you'll find the YaraML tool itself.  'python3 setup.py install' will install it.

## How well maintained is this code base?

We're providing research code here but will respond to questions and bug reports.

